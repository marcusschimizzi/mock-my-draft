---
phase: 01-data-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/draft-api/src/database/models/data-version.ts
  - apps/draft-api/src/database/models/data-import-log.ts
  - apps/draft-api/src/database/models/player.ts
  - apps/draft-api/src/database/models/player-ranking.ts
  - apps/draft-api/src/database/index.ts
  - apps/draft-api/src/services/data-versions-service.ts
  - apps/draft-api/src/services/players-service.ts
  - apps/draft-api/src/services/player-rankings.service.ts
autonomous: true

must_haves:
  truths:
    - 'Users see player data and rankings sourced from the latest published data version.'
  artifacts:
    - path: 'apps/draft-api/src/database/models/data-version.ts'
      provides: 'Data version tracking with status and active flag'
    - path: 'apps/draft-api/src/database/models/data-import-log.ts'
      provides: 'Import audit log entries tied to data versions'
    - path: 'apps/draft-api/src/services/data-versions-service.ts'
      provides: 'Active data version lookup for query filtering'
  key_links:
    - from: 'apps/draft-api/src/services/players-service.ts'
      to: 'apps/draft-api/src/services/data-versions-service.ts'
      via: 'active version filter'
      pattern: 'getActiveVersion'
    - from: 'apps/draft-api/src/services/player-rankings.service.ts'
      to: 'apps/draft-api/src/services/data-versions-service.ts'
      via: 'active version filter'
      pattern: 'getActiveVersion'
---

<objective>
Introduce data versioning and active dataset filtering in the Draft API.

Purpose: Ensure imports never overwrite live data and queries always use the latest published snapshot.
Output: New data version entities plus query filtering against the active version.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-updates/01-CONTEXT.md
@.planning/phases/01-data-updates/01-RESEARCH.md

@apps/draft-api/src/database/index.ts
@apps/draft-api/src/database/models/player.ts
@apps/draft-api/src/database/models/player-ranking.ts
@apps/draft-api/src/services/players-service.ts
@apps/draft-api/src/services/player-rankings.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add data version and import log entities</name>
  <files>
    apps/draft-api/src/database/models/data-version.ts
    apps/draft-api/src/database/models/data-import-log.ts
    apps/draft-api/src/database/models/player.ts
    apps/draft-api/src/database/models/player-ranking.ts
    apps/draft-api/src/database/index.ts
  </files>
  <action>
    Create a DataVersion entity with fields: id (uuid), source (enum: daily/manual), status (enum: pending/published/failed), isActive (boolean default false), publishedAt (nullable), createdAt, updatedAt, playerCount, rankingCount. Create a DataImportLog entity with fields: id, dataVersion (ManyToOne), status (enum), startedAt, completedAt, errorSummary (text nullable), playerCount, rankingCount, source. Add ManyToOne relations from Player and PlayerRanking to DataVersion using join column name data_version_id, and ensure PlayerRanking keeps its SourceArticle relation. Register new entities in AppDataSource entities array. Keep TypeORM naming strategy consistent with existing models and avoid adding comments unless clarifying a non-obvious field.
  </action>
  <verify>yarn nx lint draft-api</verify>
  <done>DataVersion and DataImportLog tables exist and players/rankings reference data versions.</done>
</task>

<task type="auto">
  <name>Task 2: Filter player and ranking queries by active version</name>
  <files>
    apps/draft-api/src/services/data-versions-service.ts
    apps/draft-api/src/services/players-service.ts
    apps/draft-api/src/services/player-rankings.service.ts
  </files>
  <action>
    Create a DataVersionsService that fetches the active DataVersion (isActive = true) and returns null when none exists. Update PlayersService and PlayerRankingsService to call DataVersionsService and scope queries to the active dataVersion id. For getPlayerById and getPlayerRankingById, return null if the record does not belong to the active version. Use query builder joins for PlayerRanking so filters continue to apply to sourceArticle/source relations. Keep return types unchanged and avoid any casting to any.
  </action>
  <verify>yarn nx lint draft-api</verify>
  <done>Player and ranking responses only include records tied to the active DataVersion.</done>
</task>

</tasks>

<verification>
- Data version entities are registered and queries read from the active version only.
</verification>

<success_criteria>

- Active data version exists in the database and players/rankings queries use it exclusively.
  </success_criteria>

<output>
After completion, create `.planning/phases/01-data-updates/01-01-SUMMARY.md`
</output>
